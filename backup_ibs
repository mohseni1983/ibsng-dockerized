#!/bin/bash

# Check if backup path is provided as an argument
if [ -z "$1" ]; then
  echo "Error: Backup path is missing."
  echo "Usage: $0 /path/to/backup.sql"
  exit 1
fi

BACKUP_PATH="$1"

# Database connection parameters (supports external databases via environment variables)
DB_HOST=${IBSNG_DB_HOST:-localhost}
DB_PORT=${IBSNG_DB_PORT:-5432}
DB_USER=${IBSNG_DB_USER:-ibs}
DB_NAME=${IBSNG_DB_NAME:-IBSng}

# Build pg_dump command with connection parameters
PGDUMP_CMD="pg_dump"

# Add connection parameters if not using local Unix socket
if [ "$DB_HOST" != "localhost" ] && [ "$DB_HOST" != "127.0.0.1" ] && [ -n "$DB_HOST" ]; then
    # External database connection
    export PGPASSWORD=${IBSNG_DB_PASSWORD:-ibsdbpass}
    PGDUMP_CMD="$PGDUMP_CMD -h $DB_HOST -p $DB_PORT -U $DB_USER"
else
    # Local connection - try to use postgres user if available, otherwise use configured user
    if id "postgres" &>/dev/null; then
        PGDUMP_CMD="su postgres -c \"$PGDUMP_CMD\""
    else
        export PGPASSWORD=${IBSNG_DB_PASSWORD:-ibsdbpass}
        PGDUMP_CMD="$PGDUMP_CMD -h $DB_HOST -p $DB_PORT -U $DB_USER"
    fi
fi

# Execute backup
if [ "$DB_HOST" == "localhost" ] || [ "$DB_HOST" == "127.0.0.1" ] || [ -z "$DB_HOST" ]; then
    # Local backup - use su postgres if available
    if id "postgres" &>/dev/null; then
        su postgres -c "pg_dump $DB_NAME > /tmp/IBSng_backup_$$.sql"
        if [ $? -eq 0 ]; then
            cp /tmp/IBSng_backup_$$.sql "$BACKUP_PATH"
            rm -f /tmp/IBSng_backup_$$.sql
        else
            echo "Error: Failed to backup database"
            exit 1
        fi
    else
        # Fallback to direct connection
        export PGPASSWORD=${IBSNG_DB_PASSWORD:-ibsdbpass}
        pg_dump -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" "$DB_NAME" > "$BACKUP_PATH"
        if [ $? -ne 0 ]; then
            echo "Error: Failed to backup database"
            exit 1
        fi
    fi
else
    # External database backup
    export PGPASSWORD=${IBSNG_DB_PASSWORD:-ibsdbpass}
    pg_dump -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" "$DB_NAME" > "$BACKUP_PATH"
    if [ $? -ne 0 ]; then
        echo "Error: Failed to backup external database at $DB_HOST:$DB_PORT"
        exit 1
    fi
fi

# Notify the user that the backup is ready
echo "Your backup is ready at: $BACKUP_PATH"